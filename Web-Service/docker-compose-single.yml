services:
  # Redis for Queue Management
  redis:
    image: redis:7-alpine
    container_name: handpose-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - handpose-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Python Processing Service
  processing:
    build:
      context: ./processing-service
      dockerfile: Dockerfile
    container_name: handpose-processing
    environment:
      PORT: 8000
      PYTHONUNBUFFERED: 1
    ports:
      - "8000:8000"
    volumes:
      - processing_temp:/tmp/handpose-processing
    networks:
      - handpose-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Combined Web Service (Frontend + Backend + Nginx)
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: handpose-web
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: file:/app/data/handpose.db
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: 7d
      CORS_ORIGIN: http://localhost:4856
      VITE_API_BASE_URL: http://localhost:4856/api
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      # Processing Service Configuration
      PROCESSING_SERVICE_URL: http://processing:8000
      PROCESSING_TIMEOUT: 300000
      PROCESSING_MAX_RETRIES: 3
      # Google Cloud Storage
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcs-credentials.json
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME:-dev-handpose}
      GCS_PROJECT_ID: ${GCS_PROJECT_ID:-coral-shoreline-435307-k0}
      # File Upload
      MAX_FILE_SIZE: 524288000
      ALLOWED_VIDEO_TYPES: mp4,avi,mov
      TEMP_UPLOAD_DIR: /tmp/handpose-uploads
    ports:
      - "4856:4856"
    volumes:
      - sqlite_data:/app/data
      - upload_temp:/tmp/handpose-uploads
      - ${GCS_CREDENTIALS_PATH:-./gcs-credentials.json}:/app/gcs-credentials.json:ro
    depends_on:
      redis:
        condition: service_healthy
      processing:
        condition: service_healthy
    networks:
      - handpose-network

networks:
  handpose-network:
    driver: bridge

volumes:
  sqlite_data:
  redis_data:
  processing_temp:
  upload_temp:
